/**
 * Run Art Style Migration
 * Adds art_style column to generated_ordinals table
 */

require('dotenv').config({ path: '.env.local' })
const { neon } = require('@neondatabase/serverless')
const { readFileSync } = require('fs')
const { join } = require('path')

async function runMigration() {
  const databaseUrl = process.env.NEON_DATABASE || process.env.DATABASE_URL

  if (!databaseUrl) {
    console.error('‚ùå No database URL found. Please set NEON_DATABASE or DATABASE_URL')
    process.exit(1)
  }

  console.log('üöÄ Running Art Style Migration...')
  console.log('üì° Connecting to database...')

  const sql = neon(databaseUrl)

  try {
    console.log('  Adding art_style column to generated_ordinals...')
    await sql`
      ALTER TABLE generated_ordinals
      ADD COLUMN IF NOT EXISTS art_style TEXT
    `
    console.log('  ‚úÖ Added art_style column')

    console.log('  Adding comment to art_style column...')
    try {
      await sql`
        COMMENT ON COLUMN generated_ordinals.art_style IS 'Art style used for generating this ordinal (e.g., "chibi", "anime", "pixel art", etc.)'
      `
      console.log('  ‚úÖ Added comment')
    } catch (error) {
      // Comment might fail if column doesn't support comments, that's okay
      console.log('  ‚è≠Ô∏è  Comment skipped (may not be supported)')
    }

    console.log('  Creating index on art_style...')
    await sql`
      CREATE INDEX IF NOT EXISTS idx_generated_ordinals_art_style 
      ON generated_ordinals (collection_id, art_style)
    `
    console.log('  ‚úÖ Created index')

    console.log('')
    console.log('='.repeat(50))
    console.log('‚úÖ Art Style Migration completed successfully!')
    console.log('='.repeat(50))
    console.log('')
    console.log('The art_style column has been added to generated_ordinals table.')
    console.log('All future ordinals generated by the cron job will include their art style.')

  } catch (error) {
    console.error('‚ùå Migration failed:', error)
    process.exit(1)
  }
}

runMigration()

